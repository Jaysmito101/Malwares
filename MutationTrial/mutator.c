#include <stdio.h>
#include <stdlib.h>
#include<time.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <windows.h>
#include <string.h>

const char* stringOffset = "00010855";


int get_file_size(char *source)
{
	FILE *fichier = fopen(source,"rb");
	fseek(fichier,0,SEEK_END);
	int size = ftell(fichier);
	fseek(fichier,0,SEEK_SET);
	fclose(fichier);
	return size;
}

void copy(char *source, char *dest)
{
	int srcsize = get_file_size(source);
	char *data = (char *)malloc(srcsize);
	int fsource = open(source,O_RDONLY | O_BINARY);
	int fdest = open(dest,O_WRONLY | O_CREAT | O_BINARY, 0777);
	read(fsource,data,srcsize);
	*(data + sizeof(char)*atoi(stringOffset)) = (char)(rand() % 255);
	write(fdest,data,srcsize);
	close(fsource);
	close(fdest);
}

int main(int argc, char ** argv){
	srand(time(0));
	char* dat = "THIS IS A LONG STRING TO BE POLYMORPHIC!";
	char path[100];
	DWORD length;
	length = GetModuleFileName(NULL, path, 1000);
	printf("%s\n", dat);
	char ch;
	printf("Press ENTER key to Continue\n");    
	scanf("%c",&ch); 
	copy(path, "./temp");
	system("attrib +s +h temp");
	char *cmd = (char*)malloc(256 * sizeof(char));
	char *last = strrchr(path, '\\');
	char* substr = malloc(strlen(last));
	strncpy(substr, last+1, strlen(last)-1);
	sprintf(cmd, "start /b powershell -nop -c \"sleep 1 ; del a.exe ; attrib -s -h temp ; ren temp %s \"", substr);
	system(cmd);
}	