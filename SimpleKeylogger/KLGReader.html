<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>KLGReader - Jaysmito Mukherjee</title>

	<!-- CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.4/dist/sweetalert2.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.3/codemirror.min.css" integrity="sha512-6sALqOPMrNSc+1p5xOhPwGIzs6kIlST+9oGWlI4Wwcbj1saaX9J3uzO3Vub016dmHV7hM+bMi/rfXLiF5DNIZg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

	<style type="text/css">

	body .ace_scrollbar {
	}

	body{
		align-content: center;
		background-color: rgba(15, 10, 10);
		font-family: "Arial";
		color: rgba(200, 200, 200);
	}

	button{
		padding:  10px;
		outline: none;
		font-size: 25px;
		font-family: "Arial";
		background-color: rgba(150, 150, 200);
		border: none;
		font-weight: 500;
		border-radius: 2px;
		cursor: pointer;
		transform: 0.5s;
		margin: 10px;
	}

	button:hover{
		transform: scale(1.05);
		background-color: rgba(90, 90, 120);
	}

	button:active{
		transform: scale(0.95);
	}

	#input-cover{
		width: 70%;
		height: 300px;
		margin: 50px;
		border-radius: 10px;
		overflow: hidden;
		background-color: #bdbdbd;
		transition: 0.5s;
	}

	input[type=file]{
		cursor: pointer;
		width: 100%;
		height: 100%;
		opacity:  0;
	}

	.heading2{
		width: 100%;
		transform: translateY(-200px);
		color: rgba(0, 0, 0);
		font-size: 20px;
		cursor: pointer;
	}
	#main-content{
		display: none;
	}

	#editor { 
		width: 90%;
		height: 500px;
		margin: 30px;
		border-radius: 10px;
	}
</style>
</head>
<body>

	<center>
		<div id="file-acceptor">
			<h1>
				Upload File:
			</h1>
			<div id="input-cover">
				<input type="file" id="myfile" accept=".klg">
				<h2 class="heading2" id="uploaded-name">Drag and Drop or click!</h2>
			</div>
			<br>
			<button id="open-button">Open</button>
		</div>
		<div id="main-content">
			<div id="ctrl-panel">
				<button id="rd">Raw Data</button>
				<button id="sm">Parsed View</button>
				<button id="tv">Translated View</button>
				<button id="tr">Event Tree</button>
			</div>
			<br>
			<b id="selected-view">[Select a View]</b>
			<br>
			<div id="editor">
			</div>
		</div>
	</center>

	<!-- SCRIPT IMPORTS -->

	<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.2/min/dropzone.min.js" integrity="sha512-VQQXLthlZQO00P+uEu4mJ4G4OAgqTtKG1hri56kQY1DtdLeIqhKUp9W/lllDDu3uN3SnUNawpW7lBda8+dSi7w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.4/dist/sweetalert2.all.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.62.3/codemirror.min.js" integrity="sha512-hGVnilhYD74EGnPbzyvje74/Urjrg5LSNGx0ARG1Ucqyiaz+lFvtsXk/1jCwT9/giXP0qoXSlVDjxNxjLvmqAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://pagecdn.io/lib/ace/1.4.12/ace.min.js" crossorigin="anonymous" integrity="sha256-T5QdmsCQO5z8tBAXMrCZ4f3RX8wVdiA0Fu17FGnU1vU=" ></script>
	<script src="https://pagecdn.io/lib/ace/1.4.12/theme-nord_dark.min.js" crossorigin="anonymous"  ></script>
	<script src="https://pagecdn.io/lib/ace/1.4.12/theme-pastel_on_dark.min.js" crossorigin="anonymous"  ></script>
	<script src="https://pagecdn.io/lib/ace/1.4.12/worker-json.min.js" crossorigin="anonymous"  ></script>
	<script src="https://pagecdn.io/lib/ace/1.4.12/mode-json5.min.js" crossorigin="anonymous"  ></script>
	<script type="text/javascript">
		function preventDefault(e){
			e.preventDefault();
		}

		var file = document.getElementById("myfile");
		var acceptor = document.getElementById("file-acceptor");
		var fileContainer = document.getElementById("input-cover");
		var mainContent = document.getElementById("main-content");
		var editorC = document.getElementById("editor");
		var sv = document.getElementById("selected-view");

		function showDrag(){
			document.getElementById("input-cover").style.backgroundColor = "#4567ff";
		}

		function hideDrag(){
			document.getElementById("input-cover").style.backgroundColor = "#bdbdbd";
		}

		fileContainer.ondragenter = ()=>{
			showDrag();
		}


		fileContainer.ondragleave = ()=>{
			hideDrag();
		}

		file.onchange = (e)=>{
			checkFile(e.target.files[0], (res)=>{
				if(res){
					document.getElementById("uploaded-name").innerText = "Uploaded: " + e.target.files[0].name;
					window.uploadFile = e.target.files[0];
					Swal.fire({
						title: 'Are you sure?',
						text: "Open " + e.target.files[0].name,
						icon: 'info',
						showCancelButton: true,
						confirmButtonColor: '#3085d6',
						cancelButtonColor: '#d33',
						confirmButtonText: 'Yes, Open!'
					}).then((result) => {
						if (result.isConfirmed) {
							showLoading(1000);
						}
					})
				}else{
					e.target.value = "";;
					Swal.fire({
						icon:  "error",
						title: "Error",
						text:  "File type not supported!"
					});
					hideDrag();
				}
			});
		}

		document.getElementById("open-button").onclick = () => {
			if(!window.uploadFile){
				Swal.fire({
					icon:  "error",
					title: "Error",
					text:  "File not selected!"
				});
			}else{
				showLoading(1000);
			}
		}

		function showLoading(time){
			Swal.fire({
				title: 'Loading',
				html: 'Opening file...',
				timer: time,
				timerProgressBar: true,
				allowOutsideClick: false,
				didOpen: () => {
					Swal.showLoading();
					const b = Swal.getHtmlContainer().querySelector('b')
				},
				willClose: () => {
					acceptor.style.display = "none";
					mainContent.style.display = "block";
					setupEditor();
				}
			})
		}

	// Actual Viewer Code

	async function checkFile(f, callback){
		var ab = await f.arrayBuffer();
		var data = new Int8Array(ab);
		var res =  true;
		if(data[0] != 74)
			res =  false;
		if(data[1]!=77)
			res =  false;
		if(data[2]!=0)
			res =  false;
		if(data[3]!=0)
			res =  false;
		if(data[4]!=75)
			res =  false;
		if(data[5]!=76)
			res =  false;
		if(data[6]!=71)
			res =  false;
		if(data.length < 5120)
			res = false;
		callback(res);
	}

	document.getElementById("rd").onclick = ()=>{
		sv.innerText = "[Raw Data View]";
		showRawData();
	};

	async function showRawData(){
		var out = "[KLG Veiwer Version 0.0.1] [BY JAYSMITO MUKHERJEE]";
		out += "\n\n";
		out += "HEADERS:\n\n";
		out += " [FILE NAME: " + window.uploadFile.name + "] \n";
		out += " [LOGGER VERSION: " + window.header.version + "] \n";
		out += " [CREATION TIMESTAMP: " + window.header.dateMade + "] \n\n\n";
		out += "DATA:\n\n";
		out += "[NUMBER OF SEGMENTS: " + window.segments.processed.length + "] \n\n";
		for(var i = 0;i<window.segments.processed.length;i++){
			out += "SEGMENT [" + i + "] \n\n";
			out += " [NUMBER OF EVENTS: " + window.segments.processed[i].events.length + "] \n\n";
			out += " EVENTS:\n\n";
			for(var j=0;j<window.segments.processed[i].events.length;j++){
				var ev = window.segments.processed[i].events[j];
				out += "   [EVENT (" + i + "E" + j + ")]\n";
				out += "    [TYPE: " + ev.type + "]\n";
				out += "    [SIZE: " + ev.data.length + "]\n";
				out += "    [DATA: " + ev.data + "]\n";
				out += "\n";
			}
		}
		window.editor.setValue(out, -1);
	}

	document.getElementById("sm").onclick = ()=>{
		sv.innerText = "[Parsed View]";
		showParsedData();
	};

// See: https://stackoverflow.com/questions/6937863/json-stringify-so-that-arrays-are-on-one-line
	const singleLineForNumericAndSingleItemArray = false;
	let formatJsonVtStandard = function(key, value) {
    // Edit: Without checking if it is json, strings holding numbers turn to numbers.
    if (typeof(value) === 'string' && (value.startsWith("{") || value.startsWith("["))) {
    	try {
    		value = JSON.parse(value);
    	} catch (ex) {}
    }
    if (!Array.isArray(value)) {
    	return value;
    }
    if (value.length === 0) {
    	return value;
    }
    if (singleLineForNumericAndSingleItemArray) {
        // Only keep single items and integer arrays on one line
        if (value.length > 1 && value.some(function(v) { return !Number.isInteger(v); })) {
        	return value;
        }
    }
    for (var index in value) {
    	if (typeof(value[index]) === 'object') {
            return value; // Don't support arrays that contain objects (little too tricky of a shot)
        } else if (typeof(value[index]) === 'string') { // Keep the double quotes
        	value[index] = '#¯\_(ツ)_/¯#"#¯\_(ツ)_/¯#' + value[index] + '#¯\_(ツ)_/¯#"#¯\_(ツ)_/¯#';
        }
    }
    return '#¯\_(ツ)_/¯#[#¯\_(ツ)_/¯#' + value.join('#¯\_(ツ)_/¯#,#¯\_(ツ)_/¯# ') + '#¯\_(ツ)_/¯#]#¯\_(ツ)_/¯#';
};

function prettyStringify(json, extraFormatting = null, spacing = 2) {
	const results = JSON.stringify(json, function(key, value) { let result = formatJsonVtStandard(key, value); if (extraFormatting && extraFormatting !== null) { result = extraFormatting(key, result); } return result; }, spacing);
    const results1 = results.split('\"#¯\_(ツ)_/¯#[#¯\_(ツ)_/¯#').join('[');   // string.replace is sidelined: does not replace all occurrences
    const results2 = results1.split('#¯\_(ツ)_/¯#]#¯\_(ツ)_/¯#\"').join(']');  // string.replace is sidelined: does not replace all occurrences
    const results3 = results2.split('#¯\_(ツ)_/¯#\\"#¯\_(ツ)_/¯#').join('\"'); // string.replace is sidelined: does not replace all occurrences
    const results4 = results3.split('#¯\_(ツ)_/¯#,#¯\_(ツ)_/¯#').join(',');    // string.replace is sidelined: does not replace all occurrences
    return results4;
}


async function showParsedData(){
	var data = prettyStringify(window.segments.processed, null, 4);
	data = 
	window.editor.setValue(data, -1);
}

document.getElementById("tv").onclick = ()=>{
	sv.innerText = "[Translated View]";
	showTranslatedData();
};

async function showTranslatedData(){
	var str = "";
	window.segments.processed.forEach((e)=>{
		e.events.forEach((r)=>{
			var t = r.parsed.data.str;
			str += t;
		})
	})
	window.editor.setValue(str, -1);
}

document.getElementById("tr").onclick = ()=>{
	sv.innerText = "[Event Tree View]";
	showEventTreeData();
};

async function showEventTreeData(){
	window.editor.setValue("This mode is currently not supported!");
}

async function setupEditor(){
	var editor = ace.edit("editor");
	editor.setTheme("ace/theme/nord_dark");
	editor.setOptions({
		autoScrollEditorIntoView: true,
		copyWithEmptySelection: true,
	});
	editor.setOption("mergeUndoDeltas", "always");
	editor.session.setMode("ace/mode/json5");
	window.editor = editor;
	var ab = await window.uploadFile.arrayBuffer();
	var data = new Uint8Array(ab);
	window.fileData = data;
	parseHeader();
	parseSegments();
}	

function bufferToString(arr){
	return arr.map(function(i){return String.fromCharCode(i)}).join("")
}

function parseHeader(){
	window.header = {
		"version" : window.fileData[9],
		"dateMade" : bufferToString(window.fileData.slice(64, 64+128))
	};
}

function parseSegments(){
	var segments = [];
	var segStart = 1024;
	while (segStart < window.fileData.length){
		segments.push(window.fileData.slice(segStart, segStart+4096));
		segStart = segStart+4096;
	}
	window.segments = {
		"raw" : segments,
		"processed" : []
	};
	for(var i=0;i<segments.length;i++){
		window.segments.processed.push(parseSegment(i, segments[i]));
	}
	for(var i=0;i<window.segments.processed.length;i++){
		parseEvents(window.segments.processed[i], i);
	}
}

function parseEvents(segment, segid){
	for(i=0;i<segment.events.length;i++){
		segment.events[i].parsed = {
			"eventId" : segid + "E" + i,
			"data" : parseEvent(segment.events[i])
		};
	}
}

function parseSegment(id, sg){
	var data = {
		"id" : id,
		"events" : []
	}
	var ev = {
		"type": 0,
		"data": []
	}
	for(var i=2;i<4096;){
		ev.type = sg[i++];
		if(ev.type == 0){
			return data;
		}
		var length = sg[i++];
		var bi = i;
		for(;i < bi+length;i++ ){
			ev.data.push(sg[i]);
		}
		data.events.push(ev);
		ev = {
			"type": 0,
			"data": []
		}
	}
	return data;
}

function parseLongFromBytes(bytes){
	var value = 0;
	for (var i = 0; i < 8; i++)
	{
		value |= bytes[i];
	}
	return value;
}


function parseEvent(rawEvent){
	switch(rawEvent.type){
		case 68:{
			return keyDownEv(rawEvent.data);
			break;
		}
		case 85:{
			return keyUpEv(rawEvent.data);
			break;
		}
		case 77:{
			return keyLMbDEv(rawEvent.data);
			break;
		}
		case 87:{
			return keyLMbUEv(rawEvent.data);
			break;
		}
		case 72:{
			return keyMWhEv(rawEvent.data);
			break;
		}
		default:{
			return {
				"str":"[UNKNOWN EVENT]"
			};
		}
	}
}

function  keyLMbDEv(data) {
	var mouseX = parseLongFromBytes(data.slice(0, 8));
	var mouseY = parseLongFromBytes(data.slice(8, 16));
	var timestamp = parseLongFromBytes(data.slice(16, 24));
	return {
		"str": "[CLICK (" +  mouseX + ", " + mouseY + ")]",
		"mouseX":+mouseX,
		"mouseY":mouseY,
		"timestamp":timestamp,
		"type":"LEFT_MOUSE_BUTTON_PRESSED"
	};
}

function  keyLMbUEv(data) {
	var mouseX = parseLongFromBytes(data.slice(0, 8));
	var mouseY = parseLongFromBytes(data.slice(8, 16));
	var timestamp = parseLongFromBytes(data.slice(16, 24));
	return {
		"str": "[CLICK (" +  mouseX + ", " + mouseY + ")]",
		"mouseX":+mouseX,
		"mouseY":mouseY,
		"timestamp":timestamp,
		"type":"LEFT_MOUSE_BUTTON_RELEASED"
	};
}

function  keyLMWhEv(data) {
	var mouseX = parseLongFromBytes(data.slice(0, 8));
	var mouseY = parseLongFromBytes(data.slice(8, 16));
	var timestamp = parseLongFromBytes(data.slice(16, 24));
	return {
		"str": "[CLICK (" +  mouseX + ", " + mouseY + ")]",
		"mouseX":+mouseX,
		"mouseY":mouseY,
		"timestamp":timestamp,
		"type":"MOUSE_WHEEL"
	};
}

function keyDownEv(data){
	var keycode = parseLongFromBytes(data.slice(0, 8));
	var scancode = parseLongFromBytes(data.slice(8, 16));
	var timestamp = parseLongFromBytes(data.slice(16, 24));
	return {
		"str":String.fromCharCode(keycode),
		"keycode":keycode,
		"scancode":scancode,
		"timestamp":timestamp,
		"type":"KEY_PRESSED"
	};
}

function keyUpEv(data){
	var keycode = parseLongFromBytes(data.slice(0, 8));
	var scancode = parseLongFromBytes(data.slice(8, 16));
	var timestamp = parseLongFromBytes(data.slice(16, 24));
	return {
		"str": "(" + String.fromCharCode(keycode) + ")",
		"keycode":keycode,
		"scancode":scancode,
		"timestamp":timestamp,
		"type":"KEY_RELEASED"
	};
}

</script>

</body>
</html>
