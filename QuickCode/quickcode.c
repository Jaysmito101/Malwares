/*
* Author Jaysmito Mukherjee
*
*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void print_uchar_arr(unsigned char* front, int size)
{
	for(int i = 0 ; i < size ; i++)
		printf("%d ", front[i]);
	printf("\n");
}

int rand_in_range(int min, int max, int seed)
{
	srand(seed);
	return (rand() % (max - min)) + min;
}

void reverse(unsigned char* front, int size)
{
	unsigned char tmp;
	int offset = 0;
	while(offset <= size / 2)
	{
		tmp = front[offset];
		front[offset] = front[size - offset];
		front[size - offset] = tmp;
		offset++;
	}
}

int find_in_uchar_arr(unsigned char* arr, int size, unsigned char item)
{
	for(int i = 0 ; i < 256 ; i++)
		if(arr[i] == (unsigned char)item)
			return i;
	return -1;
}

void build_basic_cipherset(unsigned char* cipherset)
{
	for(int i = 0 ; i < 256 ; i++)
		cipherset[i] = (unsigned char)i;
}

void roll_cipher(unsigned char* cipherset, int divider)
{
	reverse(cipherset, divider - 1);
	reverse(cipherset + divider + 1, 256 - divider - 2);
}

void encrypt(unsigned char* data, int size, unsigned char* pwd, int pwd_size)
{
	unsigned char cipherset[256];
	int pwd_offset = 0;
	build_basic_cipherset(cipherset);
	for(int i = 0 ; i < size ; i++)
	{
		roll_cipher(cipherset, pwd[pwd_offset++]);
		data[i] = cipherset[data[i]];
		if(pwd_offset == pwd_size)
		{
			roll_cipher(cipherset, pwd[rand_in_range(1, pwd_size - 1, i)]);
			pwd_offset = 0;
		}
	}
}

void decrypt(unsigned char* data, int size, unsigned char* pwd, int pwd_size)
{
	unsigned char cipherset[256];
	int pwd_offset = 0;
	build_basic_cipherset(cipherset);
	for(int i = 0 ; i < size ; i++)
	{
		roll_cipher(cipherset, pwd[pwd_offset++]);
		data[i] = (unsigned char)find_in_uchar_arr(cipherset, 256, data[i]);
		if(pwd_offset == pwd_size)
		{
			roll_cipher(cipherset, pwd[rand_in_range(1, pwd_size - 1, i)]);
			pwd_offset = 0;
		}
	}
}

int main(int argc, char** argv)
{
	unsigned char data[1024];
	unsigned char pwd[1024];
	printf("Enter Data : ");
	gets(data);
	printf("Enter Password : ");
	gets(pwd);
	printf("Raw       : %s\n", data);
	encrypt(data, strlen(data), pwd, strlen(pwd));
	printf("Encrypted : %s\n", data);
	decrypt(data, strlen(data), pwd, strlen(pwd));
	printf("Decrypted : %s\n", data);
}